name: Deploy S3 Bucket

on:
  push:
    branches: [ main ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy-s3:
    runs-on: self-hosted
    env:
      BUCKET_NAME: ${{ vars.BUCKET_NAME }}
      ENVIRONMENT: ${{ vars.ENVIRONMENT }}
      AWS_REGION: us-east-1

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Ensure AWS CLI v2
        run: |
          set -euo pipefail
          if command -v aws >/dev/null 2>&1; then
            echo "aws present: $(aws --version 2>&1)"
            exit 0
          fi
          echo "Installing AWS CLI v2..."
          TMP=$(mktemp -d)
          curl -sS https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o "$TMP/awscliv2.zip"
          unzip -q "$TMP/awscliv2.zip" -d "$TMP"
          sudo "$TMP/aws/install" --update
          aws --version
          rm -rf "$TMP"

      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::853973692277:role/Github-OIDC-Role
          role-session-name: github-actions
          aws-region: ${{ env.AWS_REGION }}

      - name: Create bucket if missing (enable versioning for prod)
        run: |
          set -euo pipefail
          BUCKET="${BUCKET_NAME:-}"
          if [ -z "$BUCKET" ]; then
            BUCKET="dk-feature-bucket-$(date +%Y%m%d%H%M%S)"
          fi
          ENV="${ENVIRONMENT:-dev}"
          echo "BUCKET_NAME=$BUCKET" >> $GITHUB_ENV
          echo "ENVIRONMENT=$ENV" >> $GITHUB_ENV

          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket exists: $BUCKET"
          else
            echo "Creating bucket: $BUCKET"
            if [ "${AWS_REGION}" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET" --region "$AWS_REGION"
            else
              aws s3api create-bucket --bucket "$BUCKET" --region "$AWS_REGION" --create-bucket-configuration LocationConstraint=$AWS_REGION
            fi
          fi

          if [ "${ENV,,}" = "prod" ] || [ "${ENV,,}" = "production" ]; then
            echo "Enabling versioning on $BUCKET"
            aws s3api put-bucket-versioning --bucket "$BUCKET" --versioning-configuration Status=Enabled
          fi

      - name: Upload files to S3
        run: |
          set -euo pipefail
          echo "Uploading ./upload/ to s3://$BUCKET_NAME/"
          aws s3 cp ./upload/ "s3://$BUCKET_NAME/" --recursive